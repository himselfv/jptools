Также см.:
  http://code.google.com/p/yarxi-pl/
  http://code.google.com/p/yarxi-pl/source/browse/trunk/JDFormatter.pm



=========================================================
Общие замечания:
Кодировка русского -- полностью разобрана, см. YarxiFmt.pas.

Кодировка каны:
  aikotoba
  aka
Длинные гласные показаны двоеточием:
  a:mi == aami

Ссылки на слова.
Встречаются и в Kunyomi, и в Kanji.Russian, и в Tango.Russian, однако есть особенности.
См. в соотв. разделах.


=========================================================
Kanji
  Nomer		Номер. В точности соответствует номеру записи, так что при импорте по порядку можно игнорировать.
  RusNick	Имя кандзи на русском, может содержать альтернативные записи. См. YarxiFmt.pas.
  OnYomi	Оны, см. ниже. Если пустое или "-", кокудзи.
  KunYomi	Куны, см. ниже.
  Russian	Значение, см. ниже.
  Compounds
  Str
  Utility
  Uncd		Код символа в UCS2/UTF16 (число).
  Bushu
  Dicts
  Layout
  Concise
  Yo

=== OnYomi
Формат: *kana*;*kana**;*kana*
Если в конце две звёздочки, чтение малоупотребляемое.
Строка пустая или стоит тире - кокудзи.
Могут использоваться ";" и ",".

Встречается такое (сейчас не обрабатывается):
  *cho:*(*ten**)*
  *ryu:*(*ryo:**)*
  -*do:*
  -

=== KunYomi
Формат:
  3*tsugu*^01129*|A
  0*oshi*
  ||$ $
  !5?5*omoneru*|A/O-||$a$||$o-$
  33334*aware*awareppoi*awaremu*^42909*awaremi*kanashii*^52321
  0322* AI *itoshii**mederu** AIRASHII *
  0*kura*|AN,KURA

Первым идёт набор цифр, каждая определяет, сколько букв "покрывает" кандзи в соотв. чтении:
  334*aware*awareppoi*kanashii
0 означает "покрывает всё слово".

Ему могут предшествовать до одного префикса таких видов:
  !2!
  !5?
Их роль пока неясна, yarxi-pl даёт следующие комментарии:
  !2! означает, что будут показаны 2 куна, а остальное под кат (надо скроллить).
  !2? - ???
  '!' означает показывать не все куны; '?' - не все танго.

Дальше, разделённые *, идут наборы вариантов чтения кунёми. Обычно в наборе одно чтение, если несколько - разделяются "*/*" (возможно, допустимо и без звёздочек):
  0343*jiji*/*jijii*/*jii*
Последняя * не ставится.
& значит, что чтение не показывается, но учитывается при поиске (&слово).

Восклицательный знак ! означает, что транскрипция помещается ПОД словом.
При этом кол-во транскрипций может быть больше одной (см. 1196).
!R - то же, что и !!, но только для русского словаря

Qn - "и" вместо "й" в русской транскрипции ( в n-й позиции).

После каждого чтения через * может стоять инструкция вида ~1. Это значит, что столько символов от начала чтения нужно вынести каной перед кандзи (обычно для гонорификов).

После каждого (чтения? набора?) через * может стоять инструкция вида [3]5. Это значит, что часть чтения с 4-й буквы по 5-ю опциональна (заключается в кв. скобки в Яркси).

После каждого набора через * могут стоять ссылки в форме:
  ^01129	см. также
После каждой тоже ставится *, последняя * не ставится (однако ставится закрывающая для набора, если требуется).
Иногда ссылки не отделены звёздочкой (*hiroi^50859* или *ateru*^12060^11250*)

Формат ссылок:
^[цифра][номер] === ссылка на кандзи
Цифра:
  0 = см.
  1 = ср.
  2 = ?????
  3 = реже
  4 = иначе
  5 = чаще
  6 = синоним
  7 = антоним
  8 = не путать с
  9 = ранее
  всё остальное = ??????
^[цифра][номер]-[номер] === несколько кандзи через запятую
^[цифра][номер]-''[текст]'' === доп. текст хираганой
^<блок>=[номер слова] === сделать весь блок ссылкой на указанное слово
^^: чаще хираганой (цифры не нужны)

Неверно (храню на всяк. случай):
^[цифра] === см. также
^[цифра]-[номер] === альтернативная форма в виде кандзи
^^[номер] === "сокр. от [номер]"
^^[те же варианты] == "то же, что"
Если после цифры идёт ^, то далее продолжение:
  ^3-590^690 === "реже [590][690]"
^[цифра][номер]-[номер] === несколько слов через запятую
^_[цифра][обычная ссылка] - присоединить ссылку ко варианту перевода с указанным номером для этого куна (когда их несколько).


Затем может идти |, после которого наборы вариантов чтения в сочетаниях, разделённые /. Внутри набора варианты разделяются, редкие отделяются _.
  aiso_aisox/aiso2,aiso2x_aiso2y/aiso3
  => aiso, реже aisox;
     aiso2, aiso2x, реже aiso2y;
     aiso3
  00*koromo*kinu*|I_E			i, реже e
  4*nokosu*^51070*|I_YUI/I		i, реже yui; i

Дальше могут идти:
| + набор чтений для имён. Весь набор обёрнут в $$, чтения разделяются $ ("," тоже терпит, но в природе не видел).
| + набор чтений для имён "также".
| + набор чтений для имён "реже".
Например:
  0*iso*|чтение1а_режечтение1б/чтение2а,чтение2б_режечтение2в/чтение3|$имя1а$имя1б$|$имя2а,имя2б$|$имя3$
Если какой-то из блоков |*| пуст, а последующий нет, палки всё равно ставятся: ||
  0*iso*||$имя1а$имя1б$|$имя2а,имя2б$|$имя3$

Последним идёт тире "-":
  ||$iku$|$-ka$|$aya$-$kaoru$
Для него необязательны все предшествующие палки "|"; варианты после него не показываются:
  ||$iku$|$-ka$-$hiizu$|$aya$-$kaoru$
  "iku", также "-ка" [и всё]
Но бывает и так:
  00*sakigake*^41576-0642-''ke''=21608* KAI *||$kai$-$sakigake$-$isao$-$isamu$-$tsutomu$-$hajime$

Именные чтения могут быть пустыми, при этом Яркси предпочитает оставлять внутри пробел, однако поддерживать надо все варианты пустых чтений:
  $ $
  $$
  |||
  (ничего)

Чтобы раздел "в именах" вообще появился, недостаточно наличия в Compounds вхождений "N:". Нужно указать вхождение пустого чтения имени. Яркси использует такую строку:
  ||$ $


Загадки:
  _    как сказано в yarxi-pl
  ^_   см. ниже в nomu
  *+6*
  # - кажется, это ~ (~taru)
  пробелы - в принципе понятно; описать
  
  0* IKUIKU *+6*#TARU *Q2*||$iku$|$-ka$|$aya$-$kaoru$
  222*nomu*^_242129*nondakureru*!!*nondakure*!!*|IN,NOMI
  0343*jiji*/*jijii*/*jii*Q7*^_141634-2417=23621*jiisan*^41634-2417-''san''=06815*ojiisan*~1*jiiya*


Прочее:
^4 в kunyomi_first_chunk:
  yarxi-pl говорит о каком-то ^4 во вводной цепочке kunyomi, но я таких примеров поиском не нашёл.


=== Russian
~ в начале строчки === "черновой список значений"
#курсив#
| отделяет блок трактовок кун-ёми от блока описаний сочетаний
/ разделяет значения в блоках
\ по-видимости, мусор, разделяющий значения, чтобы проще было делать поиск по одному значению

$[цифра][номер] - маленькая ссылка возле знака (видимо, вне разбиения)
0: устаревшая форма знака [номер]
1: оригинальная форма знака [номер]
2: упрощённая форма знака [номер]
3: заменён знаком [номер]
4: вариант знака [номер]
5: редкая форма знака [номер]
6: употребляется ошибочно вместо [номер]
7: теперь чаще [номер]
8: ранее также [номер]
все прочие символы: ??????

*[цифра][номер] - большая теневая ссылка справа (видимо, вне разбиения)
0: устаревшая форма: [номер]
1: оригинальная форма: [номер]
2: упрощённая форма: [номер]
3: вариантная форма: [номер]
4: редкая форма: [номер]
5: в документах: [номер]
6: синоним и омоним: [номер]
7: ошибочная форма: [номер]
все прочие символы: ????? форма

@ - описание сочетаний, проверяется первая цифра:
@0 "употребляется фонетически"
@1 "сочетания неупотребительны"
@2 "сочетания малоупотребительны"
@3 "<непродуктивно>"
@4 "в сочетаниях непродуктивен"
@5 "встречается в географических названиях"
@6 "в сочетаниях то же"
@7 "употребляется в единственном сочетании"
@8 "в сочетаниях идиоматичен"
@9 "<тж. счётный суффикс>"
@* всё прочее - пустая строка
Скобки @1(1) означают ссылку на часть Kunyomi.

Если блок сочетаний всего один, и его единственное содержимое - @описание, то оно используется вместо названия всего раздела сочетаний:
  проверка@3    => В сочетаниях: проверка <непродуктивно>
  @3            => <непродуктивно>:

&  похоже, значит ряд значений:
  ~&благоухающий,ароматный&культурно богатый|@4
 => 1. благоухающий,ароматный 2. культурно богатый

omoneru:
угодничать,пресмыкаться|льстить,угодничать@3/@0(1)/#сокр.#Африка
  угодничать,пресмыкаться |
  льстить,угодничать @3 /
  @0(1) / 
  #сокр.#Африка

awaremu:
^81865печаль,горе;жалость,сострадание/печальный,жалобный/жалеть,сострадать/сострадание,милосердие/печальный|печаль,скорбь/жалость,сострадание
  ^81865  "не путать с #1865"
   печаль,горе;жалость,сострадание /
   печальный,жалобный /
   жалеть,сострадать / 
   сострадание,милосердие /
   печальный |
   печаль,скорбь /
   жалость,сострадание

~$24803
 черновой список + упрощённая форма знака 4803

kage:
*60096&тень&оборотная сторона+/~5]благодаря#кому-чему-л.#|@6

ikuiku:
0* IKUIKU *+6*#TARU *Q2*||$iku$|$-ka$|$aya$-$kaoru$
~&благоухающий,ароматный&культурно богатый|@4
1:48667,N:8502@,N:2280,N:2279,N:55637


=== Compounds
См. YarxiFmt.

Ещё (видимо, выбросы):
 _!3!0000223223444444441110__+9*|KA,SHITA,SHIMO,GE/KA,GE,KUDARI,SAGE/KA,GE,SHIMO/KA,GE,SHITA/-KA/GE/SHITA-/KA/GE,KUDARI_1:8627,1:35440,1:58862,1:23992,1:23985,1:11064,1:26962#,2:9164#,2:57995,2:16835,2:43324,2:15385#,3:10143,3:8431,3:48480,3:17116,3:23970,3:50643^,4:17139,4:17172,4:16873,5:9141,5:16722,5:24943,6:55435,6:11190,6:24605,6:39212,6:26871,7:9292,7:10611,7:10380,8:24013#,8:23981,9:15387,9:16796,10:17163,10:16805,10:15386,11:7521,11:7524,11:7522,11:7481,12:50332,12:38527,12:9926,12:16897*,12:16795*,12:16836*,12:59281* (shita/ka/ge)
 _!5!03444333333333333333444443333333__nanise*nanniseyo*nannosono*nannara*nannarito*izure*^!43492*izureniseyo*!!*izurenishitemo*|NAN_1:41817,1:40290^,1:40488^,1:40633^,1:41692^,1:3012^,1:2114^,1:39493^,1:29053*,2:42141,2:42164,2:42096,2:42182,2:12087 (nani/ka)



=========================================================
Tango
  Nomer		Номер. В точности соответствует номеру записи, можно игнорировать.
  K1		Ссылки на кандзи, см. Введение.
  K2
  K3
  K4
  Kana		Кана, см. ниже.
  Reading	Чтение, см. ниже.
  Russian	Перевод, см. ниже.
  Hyphens	Список позиций, где следует вставить тире или пробел, напр.: "-7 9" + "aiduchiwoutsu" = "aiduchi-wo utsu".
  Yo


=== K*, Kana -- более-менее разобрано
Если не указано иначе, слово составляется как:
	K1 K2 K3 K4 Kana (Ki идут до первого нуля)
Кандзи или каны может вообще не быть.
Кана может идти в промежутках, это пишется так:
	2no4kara ==> 1 2 NO 3 4 KARA
Скобки трактуются вполне буквально:
	2(4) ==> 1 2 (3 4)
	2[4] ==> 1 2 (3 4)
Все неиспользованные кандзи добавляются в конец, то есть, можно сделать так:
	0a:kanso: ==> A:KANSO: 1 2
По умолчанию кана - хирагана; катакана включается так:
	^a:kanso: ==> A:KANSO: (катаканой)

Непонятно:
  0akarasama	akarasama	*2\прямой\,\ясный\,\открытый\;\честный\,\откровенный
	все кандзи 0, последнее -1 -- втф?
	похоже, по такой схеме пишутся все слова, которые не используют кандзи и НЕ катакана (пишутся хираганой, нативные)
  1^ei	akaei	#\ихт.#\красный хвостокол\(\скат\),=\Dasyatis akajei
	зачем такая схема? кандзи всего один, можно было не ставить 1
	видимо, ^ по умолчанию предполагает цифру перед ним (обычно это ноль), а т.к. здесь не ноль - её указали явно. Не знаю, что будет если сделать просто "^ei", и встречается ли такое.


=== Reading
Дополнительные чтения звёздочкой (ставится после каждого):
  akira*terasu*teru*

Если дополнительное чтение редкое, ставится двойная звёздочка:
  akuseku*akusaku**

Непонятно:
  aitaibaibai*(*aitai*baibai*

0^a:kanso:	a:kanso:shu:*(*a:kanso:*shu:*	>>\\[\штат\]\ Арканзас	アーカンソー州
2wo3tsu	aiduchiwoutsu*(*aiduchi*wo*utsu*	поддакивать
	то есть, *(* задаёт разбивку выражения на логические части? с помощью *
2(4)	aizenmyo:o:*(*myo:o:*aizen*	#\будд.#\Рагараджа\,\божество любви\(\один из богов-охранителей\;\санскр.#\Ragaraja\#)



=== Russian
! в начале строчки === "не проверено"
!\ === возможно, надо так
\! === !

@ === специальные фразы:
  3 = "и т.п."


=========================================================

'' === хирагана:
''no'' === (хираганой) no

# === переключение италика
#text# === text италиком

() === скобки
По умолчанию текст в скобках - италик.

>[цифры] === специальный тип слова
  1 = мужское имя
  2 = женское имя
  3 = фамилия
  4 = псевдоним
  5 = топоним
Цифры могут объединяться: >35 === "фамилия и топоним"
Повторяться: >11 == "мужские имена"

& === начало следующего варианта
Например: &строение из камня&запор на двери
  1. строение из камня
  2. запор на двери

Звёздочки:
*0 === "~shita", и т.п., 0..9:
  shita, suru, na, no, ni, de, to, taru, shite, shite iru
**0 === "~o suru", и т.п., 0..9:
  o suru, ga aru, no aru, no nai, de aru, des, da, ni suru, ni naru, to shite
***0 === "~naru", и т.п., 0..9:
  naru, kara, made, mo, wa, to suru, yori, ga shite iru, to shita, to shite iru
****0 === таких нет.
*=00 === двойной номер (их дофига, надо таблицу выдрать).
Минус перед номером значит, что весь блок в скобках:
*-4 === "(~ni)"
Закрывающая квадраная скобка после номера значит, что номер в квадратных скобках:
*4] === "~[4]"

Загадки:
\_

Примеры:
&#\муз.#\интерлюдия\(\особ.\на сямисэне между двумя песнями\)
&\оживляющий возглас\(\в песне\)
&\вставная\(#\непрошенная\#)\реплика
<i>: муз.
<i>: особ. на сямисэне между двумя песнями
<i>: в песне

Мб:
#\ === переключает италик
\(, \) === италик-скобки
\(#, \#) === не-италик скобки

1: *=00 *=01 *=02 *=03 *=04 *=05 *=06 *=07 *=08 *=09
2: *=10 *=11 *=12 *=13 *=14 *=15 *=16 *=17 *=18 *=19
3: *=20 *=21 *=22 *=23 *=24 *=25 *=26 *=27 *=28 *=29
4: *=30 *=31 *=32 *=33 *=34 *=35 *=36 *=37 *=38 *=39


=========================================================

В базе яркси нас интересуют две таблицы:
	kanji	=== содержит кандзи
	tango	=== содержит слова

Слово имеет:
	Четыре слота для номеров кандзи
	Слот для каны
	Чтение (текстом)
	Перевод (кодом)

Соответственно, по слову можно получить две вещи:
	Чтение (уже дано)
	Запись (нужно восстановить)
	
Восстановление записи:
	Если не указано иначе, слово составляется как:
		K1 K2 K3 K4 Kana (Ki идут до первого нуля)
	Кандзи или каны может вообще не быть.
	Кана может идти в промежутках, это пишется так:
		2no4kara ==> 1 2 NO 3 4 KARA
	
Поиск осуществляется так:
	- разбираем фразу на компоненты (кандзи, кана, кандзи, кана)
	- превращаем хирагану и катакану в ромадзи
	1. По записи:
		- ищем все записи по набору кандзи
		- для каждой сравниваем указанную кану, и оцениваем, она ли это
			(в словаре различается катакана-хирагана, так что нужно сравнивать с умом)
	2. По чтению:
		- находим каждый кандзи из фразу
		- находим все его чтения
		- составляем все варианты фразы
		- ищем по чтениям
Второй вариант более простой и перспективный (поскольку некоторые записанные каной
	куски могут в словаре быть записаны кандзи), однако медленнее.